#!/usr/bin/env bash

function needful () {
    local repo="$(dirname $1)"
    (
        cd $repo
        current="$(git branch | awk '/^\*/ { print $2}')"
        [ "$current" == "master" ] || git checkout master &> /dev/null
        git fetch --tags &> /dev/null
        git pull origin master &> /dev/null \
            || echo "Error! Failed to pull $repo"
        git submodule update --init &> /dev/null \
            || echo "Error! Failed to update submodules for $repo"
        [ "$current" == "master" ] || git checkout $current &> /dev/null
    )
}
export -f needful


if [ -n "$SLOW_SSH" ] ; then
    PARALLEL=1
else
    PARALLEL=10
fi

# Make sure SSH key is loaded before kicking off workers
ssh git@github.com &>/dev/null

find . -type d -name '.git' | xargs -n1 -P$PARALLEL -I{} bash -c "needful {}"
